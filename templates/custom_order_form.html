{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <h2>Place a Custom Order with {{ baker.baker_profile.bakery_name }}</h2>

  <!-- Weight -->
  <div class="form-group mb-3">
    <label>Weight (in kg)</label>
    <input type="number" id="weight" name="weight" step="0.5" class="form-control" required>
  </div>

  <!-- Cake Type -->
  <div class="form-group mb-3">
    <label>Cake Type</label>
    <select name="cake_type" class="form-control" required id="cake_type">
      {% for item in cake_types %}
      <option value="{{ item.name }}" data-price="{{ item.price }}">{{ item.name }}</option>
      {% endfor %}
    </select>


  </div>

  <!-- Frosting -->
  <div class="form-group mb-3">
    <label>Frosting</label>
    <select id="frosting" name="frosting" class="form-control" required>
      <option value="Buttercream">Buttercream</option>
      <option value="Fondant">Fondant</option>
      <option value="Whipped Cream">Whipped Cream</option>
    </select>
  </div>

  <!-- Tiers -->
  <div class="form-group mb-3">
    <label>Number of Tiers</label>
    <input type="number" id="tiers" name="tiers" class="form-control" min="1" required>
  </div>

  <!-- Theme -->
  <div class="form-group mb-3">
    <label>Theme</label>
    <input type="text" name="theme" class="form-control">
  </div>

  <!-- Message -->
  <div class="form-group mb-3">
    <label>Message on Cake</label>
    <input type="text" name="message" class="form-control">
  </div>

  <!-- Topper -->
  <div class="form-group mb-3">
    <label>Topper</label>
    <select id="topper" name="topper" class="form-control">
      <option value="None">None</option>
      <option value="Happy Birthday">Happy Birthday</option>
      <option value="Bride & Groom">Bride & Groom</option>
      <option value="Custom">Custom</option>
    </select>
  </div>

  <!-- Reference Image -->
  <div class="form-group mb-3">
    <label>Reference Image</label>
    <input type="file" name="reference_img" class="form-control">
  </div>

  <!-- Price display -->
  <p id="priceDisplay" class="mt-3 fw-bold"></p>

  <!-- Button to calculate price -->
  <button type="button" onclick="calculatePrice()" class="btn btn-success">Get Price</button>
</div>

<!-- Embed pricing as JSON safely -->
<script type="application/json" id="pricing-json">
  {{ pricing | tojson | safe }}
</script>

<!-- Parse it into JavaScript -->
<script>
  const pricingData = JSON.parse(document.getElementById('pricing-json').textContent);

  function calculatePrice() {
    const cakeSelect = document.querySelector('select[name="cake_type"]');
    const baseCakePrice = parseFloat(
      cakeSelect.options[cakeSelect.selectedIndex].getAttribute('data-price')
    );

    const weight = parseFloat(document.querySelector('input[name="weight"]').value) || 1;
    const tiers = parseInt(document.querySelector('input[name="tiers"]').value) || 1;
    const frosting = document.querySelector('select[name="frosting"]').value;
    const topper = document.querySelector('select[name="topper"]').value;

    let total = baseCakePrice;

    // ➕ Add extra price for weight over 1kg
    if (weight > 1) {
      total += pricingData.base_price_per_kg * (weight - 1);
    }

    // ➕ Add extra for additional tiers beyond 1
    if (tiers > 1) {
      total += pricingData.extra_tier_price * (tiers - 1);
    }

    // ➕ Add frosting price if set
    if (frosting && pricingData.frosting_prices[frosting]) {
      total += pricingData.frosting_prices[frosting];
    }

    // ➕ Add topper price if selected (any non-"None")
    if (topper !== 'None' && pricingData.topper_prices['Any']) {
      total += pricingData.topper_prices['Any'];
    }

    document.getElementById('priceDisplay').innerText = `Estimated Price: ₹${total.toFixed(2)}`;
    
    console.log("Base Cake Price:", baseCakePrice);
    console.log("Weight:", weight);
    console.log("Tiers:", tiers);
    console.log("Frosting:", frosting);
    console.log("Topper:", topper);

  }
</script>


{% endblock %}